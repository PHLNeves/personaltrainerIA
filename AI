<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Trainer - Gerador de Treinos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #E5E7EB; }
        #treinoOutput table { width: 100%; border-collapse: collapse; margin-top: 1rem; text-align: center; }
        #treinoOutput th, #treinoOutput td { border: 1px solid #374151; padding: 0.75rem; text-align: left; font-size: 0.875rem; }
        #treinoOutput th { background-color: #374151; color: #FBBF24; font-weight: 600; }
        #treinoOutput td { color: #F3F4F6; }
        .form-input { border: 1px solid #4B5563; background-color: #1F2937; color: #F3F4F6; padding: 0.5rem 1rem; border-radius: 0.5rem; width: 100%; }
        #treinoOutput tr:nth-child(even) { background-color: #1F2937; }
        .client-card.selected { border-color: #FBBF24 !important; background-color: #374151; box-shadow: 0 4px 6px -1px rgba(251, 191, 36, 0.3); }
        @media (max-width: 640px) {
            #treinoOutput table { display: block; overflow-x: auto; white-space: nowrap; }
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 bg-gray-900 text-gray-100">

    <!-- Modal de Confirma√ß√£o de Exclus√£o -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-red-500">
            <h3 class="text-xl font-bold text-red-400 mb-4">Confirma√ß√£o de Exclus√£o</h3>
            <p class="text-gray-300 mb-6">Tem certeza que deseja excluir os dados de <span id="modalClientName" class="font-semibold text-white"></span>?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition">Cancelar</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Excluir</button>
            </div>
        </div>
    </div>
    
    <!-- Overlay de Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400"></div>
            <p class="mt-4 text-yellow-400 text-lg">A IA est√° a periodizar o treino...</p>
        </div>
    </div>

    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-yellow-400">Personal AI Trainer üß†üí™</h1>
        <p class="text-gray-400 mt-2">Gera√ß√£o de Treinos Otimizados por IA e armazenados no Firestore</p>
    </header>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Coluna 1: Formul√°rio -->
        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-2xl h-fit border border-yellow-700/50">
            <h2 class="text-2xl font-bold text-yellow-400 mb-6 border-b border-gray-700 pb-3">Dados do Cliente</h2>
            <form id="clientForm" class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-300">Nome</label><input type="text" id="clientName" required class="form-input mt-1"></div>
                <div><label class="block text-sm font-medium text-gray-300">G√™nero</label><select id="clientGender" required class="form-input mt-1"><option value="Masculino">Masculino</option><option value="Feminino">Feminino</option></select></div>
                <div><label class="block text-sm font-medium text-gray-300">Idade</label><input type="number" id="clientAge" required class="form-input mt-1" min="15"></div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">N√≠vel</label>
                    <select id="clientLevel" required class="form-input mt-1">
                        <option value="Iniciante">Iniciante</option><option value="Iniciante Avan√ßado">Iniciante Avan√ßado</option>
                        <option value="Interm√©dio" selected>Interm√©dio</option><option value="Interm√©dio Avan√ßado">Interm√©dio Avan√ßado</option>
                        <option value="Avan√ßado">Avan√ßado</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Objetivo</label>
                    <select id="clientGoal" required class="form-input mt-1">
                        <option value="Hipertrofia Geral">Hipertrofia Geral</option><option value="Hipertrofia Est√©tica">Hipertrofia Est√©tica</option>
                        <option value="Hipertrofia Funcional">Hipertrofia Funcional</option><option value="For√ßa M√°xima">For√ßa M√°xima</option>
                        <option value="For√ßa Explosiva">For√ßa Explosiva</option><option value="Resist√™ncia Muscular">Resist√™ncia Muscular</option>
                        <option value="Perda de Gordura">Perda de Gordura</option><option value="Condicionamento Geral">Condicionamento Geral</option>
                        <option value="Reabilita√ß√£o">Reabilita√ß√£o</option><option value="Outro (Especificar)">Outro (Especificar)</option>
                    </select>
                    <input type="text" id="clientCustomGoal" placeholder="Especifique o objetivo..." class="form-input mt-1 hidden">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Split</label>
                    <select id="clientSplit" required class="form-input mt-1">
                        <option value="Full Body">Full Body</option><option value="Upper/Lower">Upper/Lower</option>
                        <option value="Push/Pull/Legs" selected>Push/Pull/Legs</option><option value="Torso e Membros">Torso e Membros</option>
                        <option value="Foco em Bra√ßos">Foco em Bra√ßos</option><option value="Foco em Membros Inferiores">Foco em Membros Inferiores</option>
                        <option value="Outro (Especificar Split)">Outro (Especificar Split)</option>
                    </select>
                    <textarea id="clientCustomSplit" placeholder="Especifique a divis√£o..." class="form-input mt-1 h-12 hidden"></textarea>
                </div>
                <div><label class="block text-sm font-medium text-gray-300">Dias/Semana</label><input type="number" id="clientDays" required class="form-input mt-1" min="1" max="7" value="4"></div>
                <div><label class="block text-sm font-medium text-gray-300">Ciclo (Semanas)</label><input type="number" id="clientCycleTime" required class="form-input mt-1" min="2" max="12" value="4"></div>
                <div><label class="block text-sm font-medium text-gray-300">Hist√≥rico/Mem√≥ria</label><textarea id="clientPreviousWorkout" class="form-input mt-1 h-20" placeholder="A IA usar√° este campo para progress√£o..."></textarea></div>
                <div><label class="block text-sm font-medium text-gray-300">Limita√ß√µes</label><textarea id="clientLimitations" class="form-input mt-1 h-20" placeholder="Les√µes, dores..."></textarea></div>
                <div>
                    <label class="block text-sm font-medium text-gray-300">Equipamento</label>
                    <select id="clientEquipment" required class="form-input mt-1">
                        <option value="Gin√°sio Completo" selected>Gin√°sio Completo</option><option value="Gin√°sio B√°sico">Gin√°sio B√°sico</option>
                        <option value="Est√∫dio Funcional">Est√∫dio Funcional</option><option value="Halteres e El√°sticos">Halteres e El√°sticos</option>
                        <option value="Peso do Corpo">Peso do Corpo</option>
                    </select>
                </div>
                <div class="flex flex-col space-y-3 mt-6">
                    <button type="submit" id="generateBtn" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-xl hover:bg-yellow-600 transition shadow-xl disabled:opacity-50">Gerar Treino com IA</button>
                    <button type="button" id="newClientBtn" class="w-full bg-gray-600 text-gray-100 font-bold py-3 rounded-xl hover:bg-gray-700 transition shadow-xl disabled:opacity-50">Novo Cliente</button>
                </div>
                <div id="authStatus" class="text-center text-sm mt-2 text-yellow-500">Aguardando inicializa√ß√£o...</div>
            </form>
        </div>

        <!-- Coluna 2: Resultados -->
        <div class="lg:col-span-2 space-y-8">
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-yellow-700/50">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-yellow-400">Treino Gerado <span id="currentClientName" class="text-yellow-600"></span></h2>
                    <button id="saveBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-xl hover:bg-gray-600 transition shadow-md disabled:opacity-50" disabled>Guardar Treino</button>
                </div>
                <div id="treinoOutput" class="min-h-[200px] text-gray-100 overflow-x-auto"><p class="text-gray-500 italic">Preencha os dados e clique em "Gerar Treino".</p></div>
                <div id="apiError" class="text-red-400 mt-4 hidden"></div>
            </div>
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-yellow-700/50">
                <h2 class="text-2xl font-bold text-yellow-400 mb-4 border-b border-gray-700 pb-3">Hist√≥rico de Clientes (Seu ID: <span id="userIdDisplay" class="font-normal text-sm text-yellow-500 break-all"></span>)</h2>
                <div id="clientsList" class="space-y-3"><p class="text-gray-500 italic">Carregando...</p></div>
            </div>
        </div>
    </div>

    <!-- SCRIPT PRINCIPAL - AQUI EST√Å A PARTE QUE VOC√ä PRECISA EDITAR -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =================================================================
        // √ÅREA DE CONFIGURA√á√ÉO (EDITE AQUI!)
        // =================================================================

        // PASSO 1: Cole aqui a configura√ß√£o que voc√™ copiou do site do Firebase
        // Apague tudo que est√° dentro das chaves { } e cole a sua config
        const firebaseConfig = {
            apiKey: "COLE_AQUI_SUA_API_KEY_DO_FIREBASE",
            authDomain: "seu-projeto.firebaseapp.com",
            projectId: "seu-projeto",
            storageBucket: "seu-projeto.appspot.com",
            messagingSenderId: "12345",
            appId: "1:12345:web:abcdef"
        };

        // PASSO 2: Defina um nome para o seu App (pode manter este ou mudar)
        const appId = 'personal-trainer-app-v1';

        // =================================================================
        // FIM DA √ÅREA DE CONFIGURA√á√ÉO DO FIREBASE
        // =================================================================

        let app, db, auth, userId = null, currentGeneratedPlan = null, currentClientId = null, clientToDeleteId = null;

        // Elementos DOM
        const els = {
            authStatus: document.getElementById('authStatus'), generateBtn: document.getElementById('generateBtn'), saveBtn: document.getElementById('saveBtn'),
            newClientBtn: document.getElementById('newClientBtn'), clientForm: document.getElementById('clientForm'), treinoOutput: document.getElementById('treinoOutput'),
            clientsList: document.getElementById('clientsList'), loadingOverlay: document.getElementById('loadingOverlay'), userIdDisplay: document.getElementById('userIdDisplay'),
            currentClientName: document.getElementById('currentClientName'), apiError: document.getElementById('apiError'),
            modal: { div: document.getElementById('deleteModal'), name: document.getElementById('modalClientName'), cancel: document.getElementById('cancelDeleteBtn'), confirm: document.getElementById('confirmDeleteBtn') },
            inputs: {
                name: document.getElementById('clientName'), gender: document.getElementById('clientGender'), age: document.getElementById('clientAge'), level: document.getElementById('clientLevel'),
                goal: document.getElementById('clientGoal'), customGoal: document.getElementById('clientCustomGoal'), split: document.getElementById('clientSplit'), customSplit: document.getElementById('clientCustomSplit'),
                days: document.getElementById('clientDays'), cycle: document.getElementById('clientCycleTime'), prevWorkout: document.getElementById('clientPreviousWorkout'), limit: document.getElementById('clientLimitations'), equip: document.getElementById('clientEquipment')
            }
        };

        function showLoading(s) { els.loadingOverlay.style.display = s ? 'flex' : 'none'; els.generateBtn.disabled = s; els.saveBtn.disabled = s; }
        function displayError(m) { els.apiError.textContent = `Erro: ${m}`; els.apiError.classList.remove('hidden'); }
        function clearError() { els.apiError.classList.add('hidden'); els.apiError.textContent = ''; }

        function clearForm() {
            els.clientForm.reset();
            if (currentClientId) { const old = document.getElementById(`client-${currentClientId}`); if (old) old.classList.remove('selected'); }
            currentClientId = null; currentGeneratedPlan = null;
            els.currentClientName.textContent = ''; els.treinoOutput.innerHTML = '<p class="text-gray-500 italic">Preencha os dados...</p>'; clearError();
            els.saveBtn.textContent = 'Guardar Treino'; els.saveBtn.disabled = true;
            els.saveBtn.classList.remove('bg-yellow-500', 'text-gray-900'); els.saveBtn.classList.add('bg-gray-500', 'text-white');
            els.inputs.customGoal.classList.add('hidden'); els.inputs.customSplit.classList.add('hidden'); els.inputs.prevWorkout.value = '';
        }

        // Firebase Logic
        function setupFirestore() {
            if (!userId) return;
            const q = query(collection(db, 'artifacts', appId, 'users', userId, 'clients'));
            onSnapshot(q, (snapshot) => {
                els.clientsList.innerHTML = '';
                if (snapshot.empty) els.clientsList.innerHTML = '<p class="text-gray-500">Sem clientes.</p>';
                snapshot.forEach((doc) => { renderClientCard({ ...doc.data(), id: doc.id }); });
            }, (e) => { console.error(e); els.clientsList.innerHTML = '<p class="text-red-500">Erro.</p>'; });
        }

        function renderClientCard(client) {
            const card = document.createElement('div');
            card.className = `client-card bg-gray-700 p-4 rounded-lg border border-gray-600 flex justify-between items-center mb-2 ${currentClientId === client.id ? 'selected' : ''}`;
            card.id = `client-${client.id}`;
            card.innerHTML = `<div class="flex-grow cursor-pointer pr-4"><h3 class="font-semibold text-yellow-500">${client.clientName}</h3><p class="text-sm text-gray-300">${client.clientGoal}</p></div>`;
            card.firstElementChild.addEventListener('click', () => loadClientData(client.id));
            const delBtn = document.createElement('button');
            delBtn.innerHTML = 'üóëÔ∏è'; delBtn.className = 'text-red-400 hover:text-red-500';
            delBtn.addEventListener('click', (e) => { e.stopPropagation(); showDeleteModal(client.id, client.clientName); });
            card.appendChild(delBtn);
            els.clientsList.appendChild(card);
        }

        function showDeleteModal(id, name) { clientToDeleteId = id; els.modal.name.textContent = name; els.modal.div.classList.remove('hidden'); }
        els.modal.cancel.addEventListener('click', () => { els.modal.div.classList.add('hidden'); clientToDeleteId = null; });
        els.modal.confirm.addEventListener('click', async () => {
            if (!clientToDeleteId) return;
            try { await deleteDoc(doc(db, 'artifacts', appId, 'users', userId, 'clients', clientToDeleteId)); if (currentClientId === clientToDeleteId) clearForm(); }
            catch (e) { console.error(e); displayError("Falha ao excluir."); }
            finally { els.modal.div.classList.add('hidden'); clientToDeleteId = null; }
        });

        async function loadClientData(id) {
            if (!userId) return;
            clearForm(); // Reset visual state
            currentClientId = id;
            const card = document.getElementById(`client-${id}`); if(card) card.classList.add('selected');
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'users', userId, 'clients', id));
                if (snap.exists()) {
                    const d = snap.data();
                    els.inputs.name.value = d.clientName; els.inputs.gender.value = d.clientGender; els.inputs.age.value = d.clientAge; els.inputs.level.value = d.clientLevel;
                    
                    if (!document.querySelector(`#clientGoal option[value="${d.clientGoal}"]`)) { els.inputs.goal.value = 'Outro (Especificar)'; els.inputs.customGoal.value = d.clientGoal; els.inputs.customGoal.classList.remove('hidden'); }
                    else { els.inputs.goal.value = d.clientGoal; }

                    if (!document.querySelector(`#clientSplit option[value="${d.clientSplit}"]`)) { els.inputs.split.value = 'Outro (Especificar Split)'; els.inputs.customSplit.value = d.clientSplit; els.inputs.customSplit.classList.remove('hidden'); }
                    else { els.inputs.split.value = d.clientSplit; }

                    els.inputs.days.value = d.clientDays; els.inputs.cycle.value = d.clientCycleTime; els.inputs.limit.value = d.clientLimitations; els.inputs.equip.value = d.clientEquipment;
                    els.inputs.prevWorkout.value = d.treinoHTML || ''; // Mem√≥ria
                    
                    els.treinoOutput.innerHTML = d.treinoHTML || ''; els.currentClientName.textContent = `| ${d.clientName}`; currentGeneratedPlan = d.treinoHTML;
                    els.saveBtn.disabled = false; els.saveBtn.textContent = 'Atualizar Treino';
                    els.saveBtn.classList.remove('bg-gray-500', 'text-white'); els.saveBtn.classList.add('bg-yellow-500', 'text-gray-900');
                }
            } catch (e) { console.error(e); displayError("Erro ao carregar."); }
        }

        // UI Handlers
        els.inputs.goal.addEventListener('change', () => els.inputs.customGoal.classList.toggle('hidden', els.inputs.goal.value !== 'Outro (Especificar)'));
        els.inputs.split.addEventListener('change', () => els.inputs.customSplit.classList.toggle('hidden', els.inputs.split.value !== 'Outro (Especificar Split)'));
        els.newClientBtn.addEventListener('click', clearForm);

        // GEMINI API
        async function fetchGeminiPlan(data) {
            clearError(); showLoading(true);
            
            // =================================================================
            // PASSO 3: CONFIGURA√á√ÉO DA CHAVE GEMINI (API KEY)
            // =================================================================
            
            const apiKey = "COLE_AQUI_SUA_CHAVE_DO_GEMINI"; // <--- COLE SUA CHAVE DENTRO DAS ASPAS

            // =================================================================

            const systemPrompt = `Voc√™ √© um Treinador Expert (ACSM). Crie um treino em Tabela HTML.
            Regras: Volume adequado ao n√≠vel (${data.clientLevel}). Sobrecarga progressiva baseada na 'MEM√ìRIA' fornecida.
            Objetivo: ${data.clientGoal}. Split: ${data.clientSplit}. G√™nero: ${data.clientGender}.
            Retorne APENAS o HTML da tabela e uma breve justificativa <p>.`;

            const userPrompt = `Cliente: ${data.clientName}, ${data.clientAge} anos, ${data.clientGender}.
            Obj: ${data.clientGoal}. Equip: ${data.clientEquipment}. Les√µes: ${data.clientLimitations}.
            --- MEM√ìRIA ANTERIOR: ${data.clientPreviousWorkout || 'Nenhuma'} ---`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: userPrompt }] }], systemInstruction: { parts: [{ text: systemPrompt }] } })
                });
                if (!response.ok) throw new Error(response.statusText);
                const json = await response.json();
                return json.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na IA";
            } catch (e) { throw e; } finally { showLoading(false); }
        }

        els.clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const goal = els.inputs.goal.value === 'Outro (Especificar)' ? els.inputs.customGoal.value : els.inputs.goal.value;
            const split = els.inputs.split.value === 'Outro (Especificar Split)' ? els.inputs.customSplit.value : els.inputs.split.value;
            const data = {
                clientName: els.inputs.name.value, clientGender: els.inputs.gender.value, clientAge: els.inputs.age.value, clientLevel: els.inputs.level.value,
                clientGoal: goal, clientSplit: split, clientDays: els.inputs.days.value, clientCycleTime: els.inputs.cycle.value,
                clientPreviousWorkout: els.inputs.prevWorkout.value, clientLimitations: els.inputs.limit.value, clientEquipment: els.inputs.equip.value
            };
            try {
                const html = await fetchGeminiPlan(data);
                els.treinoOutput.innerHTML = html; currentGeneratedPlan = html; els.currentClientName.textContent = `| ${data.clientName}`;
                els.saveBtn.disabled = false;
                els.saveBtn.textContent = currentClientId ? 'Atualizar Treino' : 'Guardar Treino';
                els.saveBtn.classList.remove('bg-gray-500', 'text-white'); els.saveBtn.classList.add('bg-yellow-500', 'text-gray-900');
            } catch (e) { displayError(e.message); }
        });

        els.saveBtn.addEventListener('click', async () => {
            if (!userId || !currentGeneratedPlan) return;
            const goal = els.inputs.goal.value === 'Outro (Especificar)' ? els.inputs.customGoal.value : els.inputs.goal.value;
            const split = els.inputs.split.value === 'Outro (Especificar Split)' ? els.inputs.customSplit.value : els.inputs.split.value;
            const data = {
                clientName: els.inputs.name.value, clientGender: els.inputs.gender.value, clientAge: els.inputs.age.value, clientLevel: els.inputs.level.value,
                clientGoal: goal, clientSplit: split, clientDays: els.inputs.days.value, clientCycleTime: els.inputs.cycle.value,
                clientPreviousWorkout: els.inputs.prevWorkout.value, clientLimitations: els.inputs.limit.value, clientEquipment: els.inputs.equip.value,
                treinoHTML: currentGeneratedPlan, updatedAt: serverTimestamp()
            };
            const docId = currentClientId || data.clientName.toLowerCase().replace(/\s+/g, '-').slice(0,20) + '-' + Date.now();
            try {
                await setDoc(doc(db, 'artifacts', appId, 'users', userId, 'clients', docId), data, { merge: true });
                els.saveBtn.textContent = 'Treino Guardado!'; els.saveBtn.disabled = true; els.saveBtn.classList.add('bg-gray-500'); els.saveBtn.classList.remove('bg-yellow-500');
                currentClientId = docId;
            } catch (e) { displayError("Erro ao salvar."); }
        });

        // Init App
        if(firebaseConfig.apiKey !== "COLE_AQUI_SUA_API_KEY_DO_FIREBASE") {
            app = initializeApp(firebaseConfig); db = getFirestore(app); auth = getAuth(app);
            signInAnonymously(auth).then(() => {
                onAuthStateChanged(auth, (u) => {
                    if (u) { userId = u.uid; els.userIdDisplay.textContent = u.uid.slice(0,5)+'...'; els.authStatus.textContent = 'Pronto.'; els.generateBtn.disabled = false; setupFirestore(); }
                });
            }).catch(e => els.authStatus.textContent = "Erro Auth");
        } else {
            els.authStatus.textContent = "‚ö†Ô∏è COLE AS CHAVES NO C√ìDIGO HTML ‚ö†Ô∏è";
        }
    </script>
</body>
</html>
