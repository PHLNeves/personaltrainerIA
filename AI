<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal AI Trainer - Gerador de Treinos</title>
    <!-- Carregamento do Tailwind CSS para estiliza√ß√£o -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Fundo Preto/Dark Gray */
            color: #E5E7EB; /* Texto padr√£o claro */
        }
        /* Estiliza√ß√£o para a √°rea de treino gerado (para manter a legibilidade da tabela) */
        #treinoOutput table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
            text-align: center;
        }
        #treinoOutput th, #treinoOutput td {
            border: 1px solid #374151; /* Borda escura */
            padding: 0.75rem;
            text-align: left;
            font-size: 0.875rem; /* Fonte um pouco menor para caber mais dados */
        }
        #treinoOutput th {
            background-color: #374151; /* Cabe√ßalho escuro */
            color: #FBBF24; /* Texto Dourado/Amarelo */
            font-weight: 600;
        }
        #treinoOutput td {
            color: #F3F4F6;
        }
        .form-input {
            border: 1px solid #4B5563; /* Borda escura */
            background-color: #1F2937; /* Input de fundo escuro */
            color: #F3F4F6; /* Texto claro no input */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            width: 100%;
        }
        /* Cor de fundo para as c√©lulas da tabela */
        #treinoOutput tr:nth-child(even) {
            background-color: #1F2937; /* Striped rows */
        }
        /* Destaque para o cliente atualmente selecionado na lista */
        .client-card.selected {
            border-color: #FBBF24 !important; /* Borda Amarela */
            background-color: #374151; /* Fundo ligeiramente mais escuro */
            box-shadow: 0 4px 6px -1px rgba(251, 191, 36, 0.3), 0 2px 4px -2px rgba(251, 191, 36, 0.3);
        }
        /* Layout responsivo para colunas da tabela em mobile */
        @media (max-width: 640px) {
            #treinoOutput table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
            }
            #treinoOutput thead, #treinoOutput tbody, #treinoOutput th, #treinoOutput td, #treinoOutput tr {
                display: block;
            }
            #treinoOutput thead {
                display: none; /* Esconde o cabe√ßalho original em mobile */
            }
            /* Recria a tabela como blocos de informa√ß√£o em mobile, se necess√°rio */
        }
    </style>
</head>
<body class="min-h-screen p-4 sm:p-8 bg-gray-900 text-gray-100">

    <!-- Modal de Confirma√ß√£o de Exclus√£o (Substitui confirm()) -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-800 p-6 rounded-xl shadow-2xl max-w-sm w-full border border-red-500">
            <h3 class="text-xl font-bold text-red-400 mb-4">Confirma√ß√£o de Exclus√£o</h3>
            <p class="text-gray-300 mb-6">Tem certeza que deseja excluir o treino e os dados de <span id="modalClientName" class="font-semibold text-white"></span>?</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelDeleteBtn" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700 transition">Cancelar</button>
                <button id="confirmDeleteBtn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition">Excluir Permanentemente</button>
            </div>
        </div>
    </div>
    
    <!-- Overlay de Loading -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex items-center justify-center z-50 hidden">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-yellow-400"></div>
            <p class="mt-4 text-yellow-400 text-lg">A IA est√° a periodizar o treino...</p>
        </div>
    </div>

    <!-- Cabe√ßalho da Aplica√ß√£o -->
    <header class="text-center mb-8">
        <h1 class="text-4xl font-extrabold text-yellow-400">Personal AI Trainer üß†üí™</h1>
        <p class="text-gray-400 mt-2">Gera√ß√£o de Treinos Otimizados por IA e armazenados no Firestore</p>
    </header>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Coluna 1: Formul√°rio de Dados do Cliente -->
        <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-2xl h-fit border border-yellow-700/50">
            <h2 class="text-2xl font-bold text-yellow-400 mb-6 border-b border-gray-700 pb-3">Dados do Cliente</h2>
            <form id="clientForm" class="space-y-4">
                
                <div>
                    <label for="clientName" class="block text-sm font-medium text-gray-300">Nome do Cliente</label>
                    <input type="text" id="clientName" required class="form-input mt-1">
                </div>
                
                <!-- G√™nero -->
                <div>
                    <label for="clientGender" class="block text-sm font-medium text-gray-300">G√™nero</label>
                    <select id="clientGender" required class="form-input mt-1">
                        <option value="Masculino" selected>Masculino</option>
                        <option value="Feminino">Feminino</option>
                    </select>
                </div>
                
                <div>
                    <label for="clientAge" class="block text-sm font-medium text-gray-300">Idade</label>
                    <input type="number" id="clientAge" required class="form-input mt-1" min="15">
                </div>
                
                <div>
                    <label for="clientLevel" class="block text-sm font-medium text-gray-300">N√≠vel de Treino</label>
                    <select id="clientLevel" required class="form-input mt-1">
                        <option value="Iniciante">Iniciante (0-6 meses)</option>
                        <option value="Iniciante Avan√ßado">Iniciante Avan√ßado (6-12 meses)</option>
                        <option value="Interm√©dio" selected>Interm√©dio (1-3 anos)</option>
                        <option value="Interm√©dio Avan√ßado">Interm√©dio Avan√ßado (3-5 anos)</option>
                        <option value="Avan√ßado">Avan√ßado (+5 anos)</option>
                    </select>
                </div>

                <!-- OBJETIVO PRINCIPAL EXPANDIDO COM OP√á√ÉO CUSTOMIZADA -->
                <div>
                    <label for="clientGoal" class="block text-sm font-medium text-gray-300">Objetivo Principal</label>
                    <select id="clientGoal" required class="form-input mt-1">
                        <option value="Hipertrofia Geral" selected>Hipertrofia Geral (Volume Equilibrado)</option>
                        <option value="Hipertrofia Est√©tica (Sarcoplasm√°tico)">Hipertrofia Est√©tica (Foco em Volume e Pump)</option>
                        <option value="Hipertrofia Funcional (Miofibrilar)">Hipertrofia Funcional (Foco em Carga e For√ßa)</option>
                        <option value="For√ßa M√°xima">For√ßa M√°xima (Foco em Levantamento)</option>
                        <option value="For√ßa Explosiva/Pot√™ncia">For√ßa Explosiva/Pot√™ncia (Treino de Salto/LPO)</option>
                        <option value="Resist√™ncia Muscular">Resist√™ncia Muscular (Alto volume/Circuito)</option>
                        <option value="Perda de Gordura/Defini√ß√£o">Perda de Gordura/Defini√ß√£o (D√©ficit cal√≥rico/Metab√≥lico)</option>
                        <option value="Condicionamento F√≠sico Geral">Condicionamento F√≠sico Geral (Equil√≠brio)</option>
                        <option value="Peak de Performance (Pr√©-Competi√ß√£o)">Peak de Performance (Pr√©-Competi√ß√£o)</option>
                        <option value="Reabilita√ß√£o e Mobilidade">Reabilita√ß√£o e Mobilidade</option>
                        <option value="Flexibilidade e Amplitude de Movimento">Flexibilidade e Amplitude de Movimento</option>
                        <option value="Outro (Especificar)">Outro (Especificar)</option> <!-- Op√ß√£o para customiza√ß√£o -->
                    </select>
                    <!-- Campo de texto para objetivo customizado, escondido por padr√£o -->
                    <input type="text" id="clientCustomGoal" placeholder="Ex: Ganho de 10kg no Agachamento em 4 semanas" class="form-input mt-1 hidden">
                </div>
                
                <!-- Divis√£o do Treino (Split) COM OP√á√ÉO CUSTOMIZADA -->
                <div>
                    <label for="clientSplit" class="block text-sm font-medium text-gray-300">Divis√£o do Treino (Split)</label>
                    <select id="clientSplit" required class="form-input mt-1">
                        <option value="Full Body (Corpo Inteiro)">Full Body (Corpo Inteiro)</option>
                        <option value="Upper/Lower (Superior/Inferior)">Upper/Lower (Superior/Inferior)</option>
                        <option value="Push/Pull/Legs (Empurrar/Puxar/Pernas)" selected>Push/Pull/Legs (Empurrar/Puxar/Pernas)</option>
                        <option value="Torso e Membros">Torso e Membros (Tipo 5x5)</option>
                        <option value="Treino com Foco em Bra√ßos">Foco em Bra√ßos (Para quem treina 3-4 dias)</option>
                        <option value="Treino com Foco em Membros Inferiores">Foco em Membros Inferiores (Para quem treina 3-4 dias)</option>
                        <option value="Espec√≠fico para Reabilita√ß√£o/Core">Espec√≠fico para Reabilita√ß√£o/Core</option>
                        <option value="Outro (Especificar Split)">Outro (Especificar Split)</option> <!-- Op√ß√£o para customiza√ß√£o do Split -->
                    </select>
                    <!-- Campo de texto para Split customizado, escondido por padr√£o -->
                    <textarea id="clientCustomSplit" placeholder="Ex: Upper A, Lower B, Full Body C (3 dias)" class="form-input mt-1 h-12 hidden"></textarea>
                </div>

                <div>
                    <label for="clientDays" class="block text-sm font-medium text-gray-300">Dias de Treino por Semana</label>
                    <input type="number" id="clientDays" required class="form-input mt-1" min="1" max="7" value="4">
                </div>
                
                <!-- Campo Ciclo de Treino -->
                <div>
                    <label for="clientCycleTime" class="block text-sm font-medium text-gray-300">Ciclo de Treino (Semanas)</label>
                    <input type="number" id="clientCycleTime" required class="form-input mt-1" min="2" max="12" value="4">
                </div>

                <!-- CAMPO ALTERADO PARA MEM√ìRIA AUTOM√ÅTICA -->
                <div>
                    <label for="clientPreviousWorkout" class="block text-sm font-medium text-gray-300">Hist√≥rico do √öltimo Treino (Mem√≥ria da IA)</label>
                    <textarea id="clientPreviousWorkout" class="form-input mt-1 h-20" placeholder="Este campo ser√° preenchido automaticamente com o √∫ltimo treino guardado. Edite para inserir um hist√≥rico manual se necess√°rio."></textarea>
                </div>
                
                <div>
                    <label for="clientLimitations" class="block text-sm font-medium text-gray-300">Les√µes / Limita√ß√µes (Detalhe)</label>
                    <textarea id="clientLimitations" class="form-input mt-1 h-20" placeholder="Ex: Dor no ombro direito, evitar supino com barra."></textarea>
                </div>
                
                <div>
                    <label for="clientEquipment" class="block text-sm font-medium text-gray-300">Equipamento Dispon√≠vel</label>
                    <select id="clientEquipment" required class="form-input mt-1">
                        <option value="Gin√°sio Completo" selected>Gin√°sio Completo (Incluindo m√°quinas avan√ßadas)</option>
                        <option value="Gin√°sio B√°sico">Gin√°sio B√°sico (Halteres, Barras, Bancos, M√°quina de Cabo)</option>
                        <option value="Est√∫dio Funcional">Est√∫dio Funcional (Kettlebells, TRX, Bola Su√≠√ßa)</option>
                        <option value="Halteres e El√°sticos">Halteres e El√°sticos em Casa</option>
                        <option value="Peso do Corpo">Apenas Peso do Corpo</option>
                    </select>
                </div>

                <div class="flex flex-col space-y-3 mt-6">
                    <button type="submit" id="generateBtn" class="w-full bg-yellow-500 text-gray-900 font-bold py-3 rounded-xl hover:bg-yellow-600 transition duration-300 shadow-xl hover:shadow-yellow-500/50 disabled:opacity-50">
                        Gerar Treino com IA
                    </button>
                    <!-- Bot√£o Novo Cliente/Limpar -->
                    <button type="button" id="newClientBtn" class="w-full bg-gray-600 text-gray-100 font-bold py-3 rounded-xl hover:bg-gray-700 transition duration-300 shadow-xl disabled:opacity-50">
                        Novo Cliente / Limpar Formul√°rio
                    </button>
                </div>
                
                <div id="authStatus" class="text-center text-sm mt-2 text-yellow-500">Aguardando inicializa√ß√£o...</div>

            </form>
        </div>

        <!-- Coluna 2 e 3: √Årea de Resultados e Hist√≥rico -->
        <div class="lg:col-span-2 space-y-8">
            
            <!-- Resultado do Treino Gerado -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-yellow-700/50">
                <div class="flex justify-between items-center border-b border-gray-700 pb-3 mb-4">
                    <h2 class="text-2xl font-bold text-yellow-400">Treino Gerado <span id="currentClientName" class="text-yellow-600"></span></h2>
                    <button id="saveBtn" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-xl hover:bg-gray-600 transition duration-300 shadow-md disabled:opacity-50" disabled>
                        Guardar Treino
                    </button>
                </div>
                <div id="treinoOutput" class="min-h-[200px] text-gray-100 overflow-x-auto">
                    <p class="text-gray-500 italic">Preencha os dados do cliente e clique em "Gerar Treino com IA".</p>
                </div>
                <div id="apiError" class="text-red-400 mt-4 hidden"></div>
            </div>

            <!-- Hist√≥rico de Clientes (Firestore) -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-2xl border border-yellow-700/50">
                <h2 class="text-2xl font-bold text-yellow-400 mb-4 border-b border-gray-700 pb-3">Hist√≥rico de Clientes (Seu ID: <span id="userIdDisplay" class="font-normal text-sm text-yellow-500 break-all"></span>)</h2>
                <div id="clientsList" class="space-y-3">
                    <p class="text-gray-500 italic">Carregando clientes...</p>
                </div>
            </div>
        </div>

    </div>

    <!-- Script de Firebase e L√≥gica da Aplica√ß√£o -->
    <script type="module">
        // Importa√ß√µes do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Adicionada a fun√ß√£o deleteDoc para exclus√£o
        import { getFirestore, doc, setDoc, collection, query, onSnapshot, serverTimestamp, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs de debug para o Firestore
        setLogLevel('debug');

        // Vari√°veis globais de ambiente (fornecidas pelo Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let app;
        let db;
        let auth;
        let userId = null;
        let currentGeneratedPlan = null; // Armazena o √∫ltimo treino gerado
        let currentClientId = null; // Armazena o ID do cliente atual (para salvar/carregar/excluir)
        let clientToDeleteId = null; // Armazena temporariamente o ID do cliente a ser exclu√≠do

        // Elementos DOM
        const authStatusEl = document.getElementById('authStatus');
        const generateBtn = document.getElementById('generateBtn');
        const saveBtn = document.getElementById('saveBtn');
        const newClientBtn = document.getElementById('newClientBtn'); 
        const clientForm = document.getElementById('clientForm');
        const treinoOutputEl = document.getElementById('treinoOutput');
        const clientsListEl = document.getElementById('clientsList');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const userIdDisplay = document.getElementById('userIdDisplay');
        const currentClientNameEl = document.getElementById('currentClientName');
        const apiErrorEl = document.getElementById('apiError');
        
        // Modal de Exclus√£o
        const deleteModal = document.getElementById('deleteModal');
        const modalClientNameEl = document.getElementById('modalClientName');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // Campos Customizados
        const clientGoalEl = document.getElementById('clientGoal');
        const clientCustomGoalEl = document.getElementById('clientCustomGoal');
        const clientSplitEl = document.getElementById('clientSplit');
        const clientCustomSplitEl = document.getElementById('clientCustomSplit');
        // Novo elemento para o campo de mem√≥ria
        const clientPreviousWorkoutEl = document.getElementById('clientPreviousWorkout');

        // --- Fun√ß√µes Auxiliares de UI ---
        
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
            generateBtn.disabled = show;
            saveBtn.disabled = show;
        }

        function displayError(message) {
            apiErrorEl.textContent = `Erro: ${message}`;
            apiErrorEl.classList.remove('hidden');
        }

        function clearError() {
            apiErrorEl.classList.add('hidden');
            apiErrorEl.textContent = '';
        }
        
        // Fun√ß√£o para limpar o formul√°rio e redefinir o estado
        function clearForm() {
            // 1. Resetar o formul√°rio
            clientForm.reset();
            
            // 2. Resetar o estado da edi√ß√£o e limpar highlight
            if (currentClientId) {
                const oldSelected = document.getElementById(`client-${currentClientId}`);
                if (oldSelected) {
                    oldSelected.classList.remove('selected');
                }
            }
            currentClientId = null;
            currentGeneratedPlan = null;

            // 3. Resetar elementos visuais
            currentClientNameEl.textContent = '';
            treinoOutputEl.innerHTML = '<p class="text-gray-500 italic">Preencha os dados do cliente e clique em "Gerar Treino com IA".</p>';
            clearError();

            // 4. Resetar bot√£o de salvar para o estado inicial
            saveBtn.textContent = 'Guardar Treino';
            saveBtn.disabled = true; 
            saveBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
            saveBtn.classList.add('bg-gray-500', 'hover:bg-gray-600', 'text-white');

            // 5. Esconder e limpar campos customizados e o campo de mem√≥ria
            clientCustomGoalEl.classList.add('hidden');
            clientCustomGoalEl.required = false;
            clientCustomGoalEl.value = '';

            clientCustomSplitEl.classList.add('hidden');
            clientCustomSplitEl.required = false;
            clientCustomSplitEl.value = '';

            // Limpa o campo de mem√≥ria para novos clientes
            clientPreviousWorkoutEl.value = ''; 
        }
        
        // --- L√≥gica do Firestore ---

        // Caminho da cole√ß√£o de clientes para o usu√°rio atual
        function getClientCollectionRef() {
            return collection(db, 'artifacts', appId, 'users', userId, 'clients');
        }

        // Configura o listener para buscar a lista de clientes em tempo real
        function setupFirestoreListeners() {
            if (!userId) return;

            const q = query(getClientCollectionRef());
            
            onSnapshot(q, (snapshot) => {
                clientsListEl.innerHTML = '';
                if (snapshot.empty) {
                    clientsListEl.innerHTML = '<p class="text-gray-500">Ainda n√£o tem clientes guardados.</p>';
                } else {
                    snapshot.forEach((doc) => {
                        const client = doc.data();
                        client.id = doc.id;
                        renderClientCard(client);
                    });
                }
            }, (error) => {
                console.error("Erro ao ouvir clientes:", error);
                clientsListEl.innerHTML = '<p class="text-red-500">Erro ao carregar dados.</p>';
            });
        }

        // Renderiza um cart√£o de cliente no hist√≥rico
        function renderClientCard(client) {
            const card = document.createElement('div');
            // Classes base do cart√£o
            card.className = 'client-card bg-gray-700 p-4 rounded-lg border border-gray-600 transition duration-150 flex justify-between items-center';
            card.id = `client-${client.id}`;

            // Conte√∫do do cart√£o
            const content = document.createElement('div');
            content.className = 'flex-grow cursor-pointer pr-4';
            content.innerHTML = `
                <h3 class="font-semibold text-yellow-500 text-lg">${client.clientName}</h3>
                <p class="text-sm text-gray-300">Objetivo: ${client.clientGoal} | N√≠vel: ${client.clientLevel}</p>
            `;
            // Adiciona evento para carregar dados ao clicar no conte√∫do (√°rea principal)
            content.addEventListener('click', () => loadClientData(client.id));

            // Bot√µes de a√ß√£o (excluir)
            const actions = document.createElement('div');
            actions.className = 'flex-shrink-0';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 hover:text-red-500" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd" />
                </svg>
            `;
            deleteBtn.title = `Excluir ${client.clientName}`;
            // Adiciona evento para abrir o modal de exclus√£o
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); // Previne que o click acione o loadClientData
                showDeleteModal(client.id, client.clientName);
            });

            actions.appendChild(deleteBtn);
            card.appendChild(content);
            card.appendChild(actions);

            // Se for o cliente atualmente carregado, aplica a classe de destaque
            if (currentClientId === client.id) {
                card.classList.add('selected');
            }

            clientsListEl.appendChild(card);
        }

        // Exibe o modal de confirma√ß√£o de exclus√£o
        function showDeleteModal(clientId, clientName) {
            clientToDeleteId = clientId;
            modalClientNameEl.textContent = clientName;
            deleteModal.classList.remove('hidden');
        }

        // Fun√ß√£o para exclus√£o
        async function deleteClient() {
            if (!clientToDeleteId || !userId) {
                console.error("Erro: Cliente ou Usu√°rio n√£o definido para exclus√£o.");
                return;
            }

            showLoading(true);

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'clients', clientToDeleteId);
                await deleteDoc(docRef);

                // Se o cliente exclu√≠do era o que estava no formul√°rio, limpa o formul√°rio
                if (currentClientId === clientToDeleteId) {
                    clearForm();
                }

                // A lista √© atualizada automaticamente pelo onSnapshot

            } catch (error) {
                console.error("Erro ao excluir cliente:", error);
                displayError("Falha ao excluir o cliente do Firestore.");
            } finally {
                clientToDeleteId = null;
                deleteModal.classList.add('hidden');
                showLoading(false);
            }
        }


        // Carrega um treino guardado para visualiza√ß√£o
        async function loadClientData(clientId) {
            if (!userId) {
                displayError("Usu√°rio n√£o autenticado para carregar dados.");
                return;
            }
            
            // 1. Limpa o highlight anterior e aplica o novo
            if (currentClientId) {
                const oldSelected = document.getElementById(`client-${currentClientId}`);
                if (oldSelected) {
                    oldSelected.classList.remove('selected');
                }
            }
            currentClientId = clientId;

            const newSelected = document.getElementById(`client-${clientId}`);
            if (newSelected) {
                newSelected.classList.add('selected');
            }

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'clients', clientId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // Preenche o formul√°rio com os dados do cliente
                    document.getElementById('clientName').value = data.clientName;
                    document.getElementById('clientGender').value = data.clientGender || 'Masculino';
                    document.getElementById('clientAge').value = data.clientAge;
                    document.getElementById('clientLevel').value = data.clientLevel;
                    
                    // L√≥gica para carregar o objetivo (Goal)
                    const goalIsCustom = !clientGoalEl.querySelector(`option[value="${data.clientGoal}"]`);
                    if (goalIsCustom) {
                        clientGoalEl.value = 'Outro (Especificar)';
                        clientCustomGoalEl.value = data.clientGoal;
                        clientCustomGoalEl.classList.remove('hidden');
                        clientCustomGoalEl.required = true;
                    } else {
                        clientGoalEl.value = data.clientGoal;
                        clientCustomGoalEl.classList.add('hidden');
                        clientCustomGoalEl.required = false;
                        clientCustomGoalEl.value = '';
                    }

                    // L√≥gica para carregar a Divis√£o (Split)
                    const splitIsCustom = !clientSplitEl.querySelector(`option[value="${data.clientSplit}"]`);
                    if (splitIsCustom) {
                        clientSplitEl.value = 'Outro (Especificar Split)';
                        clientCustomSplitEl.value = data.clientSplit;
                        clientCustomSplitEl.classList.remove('hidden');
                        clientCustomSplitEl.required = true;
                    } else {
                        clientSplitEl.value = data.clientSplit;
                        clientCustomSplitEl.classList.add('hidden');
                        clientCustomSplitEl.required = false;
                        clientCustomSplitEl.value = '';
                    }

                    document.getElementById('clientDays').value = data.clientDays;
                    document.getElementById('clientCycleTime').value = data.clientCycleTime || '4'; 
                    
                    // --- MUDAN√áA CRUCIAL: POPULA O CAMPO DE MEM√ìRIA COM O TREINO HTML ANTERIOR ---
                    // Este √© o mecanismo de progress√£o. O novo treino ser√° gerado baseado neste HTML guardado.
                    document.getElementById('clientPreviousWorkout').value = data.treinoHTML || '';
                    // O campo de limita√ß√µes (o √∫nico outro campo de texto livre)
                    document.getElementById('clientLimitations').value = data.clientLimitations || '';

                    document.getElementById('clientEquipment').value = data.clientEquipment;

                    // Exibe o treino
                    treinoOutputEl.innerHTML = data.treinoHTML || '<p class="text-gray-500 italic">Treino guardado sem conte√∫do.</p>';
                    currentClientNameEl.textContent = `| ${data.clientName}`;
                    currentGeneratedPlan = data.treinoHTML;
                    
                    // Configura o bot√£o para o modo "Atualizar"
                    saveBtn.disabled = false; 
                    saveBtn.textContent = 'Atualizar Treino'; 
                    saveBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600', 'text-white');
                    saveBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');


                } else {
                    displayError("Treino n√£o encontrado.");
                }
            } catch (error) {
                console.error("Erro ao carregar cliente:", error);
                displayError("Falha ao carregar dados do cliente.");
            }
        }
        
        // --- L√≥gica de UI para Campos Customizados ---

        // L√≥gica para Objetivo Customizado
        clientGoalEl.addEventListener('change', () => {
            if (clientGoalEl.value === 'Outro (Especificar)') {
                clientCustomGoalEl.classList.remove('hidden');
                clientCustomGoalEl.required = true;
            } else {
                clientCustomGoalEl.classList.add('hidden');
                clientCustomGoalEl.required = false;
                clientCustomGoalEl.value = ''; // Limpa o input customizado ao voltar
            }
        });

        // L√≥gica para Split Customizado
        clientSplitEl.addEventListener('change', () => {
            if (clientSplitEl.value === 'Outro (Especificar Split)') {
                clientCustomSplitEl.classList.remove('hidden');
                clientCustomSplitEl.required = true;
            } else {
                clientCustomSplitEl.classList.add('hidden');
                clientCustomSplitEl.required = false;
                clientCustomSplitEl.value = ''; // Limpa o input customizado ao voltar
            }
        });

        // --- Gera√ß√£o de Treino (API Gemini) ---
        
        async function fetchGeminiPlan(clientData) {
            clearError();
            showLoading(true);

            // O Prompt Mestre que voc√™ criou, incorporado como System Instruction
            const systemInstructionText = `
                Voc√™ √© um Treinador de Alta Performance e Especialista em Biomec√¢nica.
                Siga as diretrizes do ACSM e use a evid√™ncia cient√≠fica mais recente para gerar o treino.
                O seu objetivo √© criar uma rotina de treino de muscula√ß√£o (periodiza√ß√£o de um mesociclo).

                REGRAS CIENT√çFICAS:
                1. Volume de Treino:
                   - Iniciantes: 6-10 s√©ries semanais por grupo muscular.
                   - Iniciantes Avan√ßados: 8-12 s√©ries semanais.
                   - Interm√©dios: 10-16 s√©ries semanais.
                   - Interm√©dios Avan√ßados: 14-18 s√©ries semanais.
                   - Avan√ßados: 18-22+ s√©ries semanais.
                2. Sele√ß√£o de Exerc√≠cios: Come√ßar com compostos e terminar com isolados. Ajustar a sele√ß√£o de exerc√≠cios com base no 'Objetivo Principal' detalhado.
                   - Ex: Para Hipertrofia Est√©tica, use mais exerc√≠cios de isolamento e t√©cnicas metab√≥licas (Drop-sets, Supersets, etc.). Para Hipertrofia Funcional/For√ßa, priorize exerc√≠cios com barra/pesos livres e RPE mais alto (foco em tens√£o mec√¢nica).
                3. Intensidade e Carga: Use a escala RPE 7-9 (1 a 3 reps na reserva) para hipertrofia, ou RPE 8-10 para for√ßa.
                4. Descanso: 2-4 minutos para compostos pesados, 60-90 segundos para isolados/metab√≥licos.
                5. Seguran√ßa: Se houver les√£o citada, exclua exerc√≠cios que sobrecarreguem a articula√ß√£o afetada e sugira variantes seguras.
                6. Adapta√ß√£o de G√™nero: Se o g√™nero for "Feminino" e o objetivo for Hipertrofia, ajuste o volume para priorizar o treino de gl√∫teos e quadr√≠ceps (pode alocar volume extra), mantendo o volume superior dentro das diretrizes, respeitando o Split selecionado.
                7. Progress√£o: Se o cliente fornecer o '√öltimo Treino Prescrito', voc√™ DEVE analisar o HTML fornecido para entender a rotina anterior e implementar sobrecarga progressiva (aumentando repeti√ß√µes, s√©ries, densidade, ou intensidade/RPE) nos exerc√≠cios centrais, mantendo a estrutura original do Split.
                8. Divis√£o (Split): A divis√£o de treino deve seguir rigorosamente o tipo de Split selecionado pelo cliente (${clientData.clientSplit}).
                
                FORMATO OBRIGAT√ìRIO DE SA√çDA:
                Gere o treino completo em HTML, usando a tag <table>. N√£o inclua Markdown (como \`\`\`).
                A tabela DEVE ter as colunas: Exerc√≠cio, S√©ries, Repeti√ß√µes, RPE/Intensidade, Descanso, Notas de Execu√ß√£o (Cues).
                Crie o treino dividido por dia (ex: Dia 1 - Peito/Tr√≠ceps).
                
                No final da resposta, inclua uma breve justifica√ß√£o cient√≠fica SOB UMA TAG HTML <p> sobre a escolha da divis√£o de treino e como ela se relaciona com o ciclo de ${clientData.clientCycleTime} semanas, o objetivo principal, o g√™nero do cliente e a progress√£o (se aplic√°vel).
                A sua resposta deve ser APENAS o HTML da tabela e a justifica√ß√£o.
            `;
            
            // Monta o prompt espec√≠fico com os dados do cliente
            const userQuery = `
                Crie um treino completo e detalhado para este cliente:
                - Nome: ${clientData.clientName}
                - G√©nero: ${clientData.clientGender}
                - Idade: ${clientData.clientAge}
                - N√≠vel de Treino: ${clientData.clientLevel}
                - Dias dispon√≠veis: ${clientData.clientDays}
                - Dura√ß√£o do Ciclo de Treino (Mesociclo): ${clientData.clientCycleTime} semanas.
                - Objetivo Principal: ${clientData.clientGoal}
                - Divis√£o de Treino (Split): ${clientData.clientSplit}
                - Les√µes ou Limita√ß√µes: ${clientData.clientLimitations || 'Nenhuma'}
                - Equipamento Dispon√≠vel: ${clientData.clientEquipment}
                
                --- MEM√ìRIA DO √öLTIMO TREINO (USE PARA A PROGRESS√ÉO) ---
                ${clientData.clientPreviousWorkout || 'Nenhum hist√≥rico de treino anterior fornecido. Comece um novo ciclo.'}
                --- FIM DA MEM√ìRIA ---

                O plano deve ser projetado para um mesociclo de ${clientData.clientCycleTime} semanas, adaptando o volume e a intensidade de acordo com o n√≠vel de ${clientData.clientLevel}, o objetivo principal (foco: ${clientData.clientGoal}), o g√™nero, o Split selecionado e, crucialmente, implementando progress√£o analisando a 'MEM√ìRIA' acima.
            `;
            
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const maxRetries = 5;

            // L√≥gica de Tentar e Repetir (Exponential Backoff)
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const payload = {
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemInstructionText }] } // Passa a instru√ß√£o din√¢mica
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && i < maxRetries - 1) {
                            const delay = Math.pow(2, i) * 1000; // Atraso: 1s, 2s, 4s, ...
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Tenta novamente
                        }
                        throw new Error(`Erro da API: ${response.status} ${response.statusText}`);
                    }

                    const result = await response.json();
                    showLoading(false);

                    const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (text) {
                        return text; // Retorna o treino gerado em HTML
                    } else {
                        throw new Error("Resposta da IA vazia ou mal formatada.");
                    }

                } catch (error) {
                    showLoading(false);
                    console.error("Erro na comunica√ß√£o com a API Gemini:", error);
                    displayError(`Falha ao gerar treino: ${error.message}.`);
                    if (i === maxRetries - 1) throw error; // Re-lan√ßa o erro no √∫ltimo retry
                }
            }
        }
        
        // --- Handlers de Eventos ---
        
        // Modal Handlers
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            clientToDeleteId = null;
        });

        confirmDeleteBtn.addEventListener('click', deleteClient);


        clientForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Determina o objetivo final (dropdown ou input customizado)
            const goalValue = clientGoalEl.value;
            const finalGoal = (goalValue === 'Outro (Especificar)' && clientCustomGoalEl.value.trim() !== '') 
                ? clientCustomGoalEl.value.trim() 
                : goalValue;
            
            if (finalGoal === 'Outro (Especificar)') {
                displayError("Por favor, especifique o objetivo customizado ou escolha uma op√ß√£o da lista.");
                return;
            }

            // Determina o Split final (dropdown ou input customizado)
            const splitValue = clientSplitEl.value;
            const finalSplit = (splitValue === 'Outro (Especificar Split)' && clientCustomSplitEl.value.trim() !== '') 
                ? clientCustomSplitEl.value.trim() 
                : splitValue;

            if (finalSplit === 'Outro (Especificar Split)') {
                displayError("Por favor, especifique o Split customizado ou escolha uma op√ß√£o da lista.");
                return;
            }

            const clientData = {
                clientName: document.getElementById('clientName').value.trim(),
                clientGender: document.getElementById('clientGender').value,
                clientAge: document.getElementById('clientAge').value,
                clientLevel: document.getElementById('clientLevel').value,
                clientGoal: finalGoal, // Usa o objetivo final
                clientSplit: finalSplit, // Usa o split final
                clientDays: document.getElementById('clientDays').value,
                clientCycleTime: document.getElementById('clientCycleTime').value, 
                // Agora envia o conte√∫do da √°rea de texto, que cont√©m o HTML do treino anterior se um cliente foi carregado
                clientPreviousWorkout: clientPreviousWorkoutEl.value.trim(), 
                clientLimitations: document.getElementById('clientLimitations').value.trim(),
                clientEquipment: document.getElementById('clientEquipment').value,
                createdAt: serverTimestamp()
            };

            if (!clientData.clientName || clientData.clientName.length < 2) {
                displayError("Por favor, insira um nome de cliente v√°lido.");
                return;
            }

            try {
                // 1. Gerar o treino
                const treinoHTML = await fetchGeminiPlan(clientData);
                
                // 2. Mostrar o treino gerado
                treinoOutputEl.innerHTML = treinoHTML;
                currentGeneratedPlan = treinoHTML;
                currentClientNameEl.textContent = `| ${clientData.clientName}`;
                
                // 3. Preparar para guardar/atualizar
                saveBtn.disabled = false;
                
                // Se currentClientId estiver setado, √© uma atualiza√ß√£o. Se for null, √© um novo.
                if (currentClientId) {
                    saveBtn.textContent = 'Atualizar Treino'; // Cliente existente est√° sendo re-gerado
                } else {
                    saveBtn.textContent = 'Guardar Treino'; // Novo cliente
                }
                
                saveBtn.classList.remove('bg-gray-500', 'hover:bg-gray-600', 'text-white');
                saveBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');

            } catch (error) {
                // Erro j√° tratado e exibido em displayError() dentro de fetchGeminiPlan
            }
        });

        saveBtn.addEventListener('click', async () => {
            if (!currentGeneratedPlan || !userId) {
                displayError("Nenhum treino para guardar ou usu√°rio n√£o autenticado.");
                return;
            }

            // Garante que o objetivo customizado seja salvo corretamente
            const goalValue = clientGoalEl.value;
            const finalGoal = (goalValue === 'Outro (Especificar)' && clientCustomGoalEl.value.trim() !== '') 
                ? clientCustomGoalEl.value.trim() 
                : goalValue;
            
            // Garante que o split customizado seja salvo corretamente
            const splitValue = clientSplitEl.value;
            const finalSplit = (splitValue === 'Outro (Especificar Split)' && clientCustomSplitEl.value.trim() !== '') 
                ? clientCustomSplitEl.value.trim() 
                : splitValue;


            const clientData = {
                clientName: document.getElementById('clientName').value.trim(),
                clientGender: document.getElementById('clientGender').value,
                clientAge: document.getElementById('clientAge').value,
                clientLevel: document.getElementById('clientLevel').value,
                clientGoal: finalGoal,
                clientSplit: finalSplit,
                clientDays: document.getElementById('clientDays').value,
                clientCycleTime: document.getElementById('clientCycleTime').value, 
                // O conte√∫do HTML do treino gerado √© guardado no campo 'treinoHTML'
                treinoHTML: currentGeneratedPlan, 
                // Adicionando um timestamp de atualiza√ß√£o
                updatedAt: serverTimestamp()
            };
            
            // Se um cliente for carregado, ele j√° tem um ID, ent√£o podemos usar esse ID para atualizar.
            const docId = currentClientId || clientData.clientName.toLowerCase().replace(/\s+/g, '-').slice(0, 50) + '-' + Date.now();
            const clientDocRef = doc(db, 'artifacts', appId, 'users', userId, 'clients', docId);

            try {
                await setDoc(clientDocRef, clientData, { merge: true });

                saveBtn.textContent = 'Treino Guardado!';
                // Desabilita e muda a cor para indicar que foi salvo
                saveBtn.disabled = true; 
                saveBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600', 'text-gray-900');
                saveBtn.classList.add('bg-gray-500', 'hover:bg-gray-600', 'text-white');
                
                currentClientId = docId; // Atualiza o ID caso seja um novo

                // A lista √© atualizada automaticamente pelo onSnapshot
            } catch (error) {
                console.error("Erro ao guardar treino:", error);
                displayError("Falha ao guardar o treino no Firestore.");
            }
        });
        
        // Listener para o novo bot√£o "Novo Cliente"
        newClientBtn.addEventListener('click', clearForm);

        // Inicializa o bot√£o de gerar no carregamento
        generateBtn.disabled = true;
        saveBtn.disabled = true;

        // --- Configura√ß√£o Inicial de Autentica√ß√£o ---
        if (firebaseConfig) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // Tenta usar o token de auth customizado primeiro
            const signInPromise = initialAuthToken
                ? signInWithCustomToken(auth, initialAuthToken).catch(e => {
                    console.warn("Falha ao entrar com token customizado. Tentando anonimamente.", e);
                    // Se falhar, tenta an√¥nimo
                    return signInAnonymously(auth);
                })
                : signInAnonymously(auth); // Se n√£o houver token, tenta an√¥nimo

            signInPromise.then(() => {
                // Configura o listener do estado de autentica√ß√£o
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // Usu√°rio autenticado (ou an√¥nimo)
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        authStatusEl.textContent = `Sess√£o ativa. User ID: ${userId.slice(0, 8)}...`;
                        generateBtn.disabled = false; // Habilita o bot√£o de gera√ß√£o ap√≥s a autentica√ß√£o
                        setupFirestoreListeners(); // Inicia a escuta dos dados
                    } else {
                        // Nenhuma sess√£o ativa (deve ser raro devido ao signInPromise)
                        userId = null;
                        userIdDisplay.textContent = 'N√£o Autenticado';
                        authStatusEl.textContent = 'Por favor, inicie sess√£o.';
                        generateBtn.disabled = true;
                    }
                });
            }).catch(error => {
                console.error("Erro fatal na autentica√ß√£o:", error);
                authStatusEl.textContent = `Erro na autentica√ß√£o: ${error.message}`;
            });
        } else {
            authStatusEl.textContent = 'Erro: Configura√ß√£o do Firebase n√£o encontrada.';
        }
    </script>
</body>
</html>
